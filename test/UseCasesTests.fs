module JoyReactor.Tests.UseCasesTests

open System
open Elmish
open Swensen.Unquote
open Xunit
open JoyReactor.Components

module D = ApplicationScreen
type R = Text.RegularExpressions.Regex

module SyncDownloader = 
    open JoyReactor.WebCli

    let private downloadHtml (url : string) = 
        let encodedUrl = Text.Encoding.UTF8.GetBytes url |> Convert.ToBase64String
        let path = sprintf "../../../Resources/htmls/%s.html" encodedUrl
        if not <| IO.File.Exists path then printfn "Can't find url %s (%s)" url path
        IO.File.ReadAllText path |> async.Return
    let downloadImpl url =
        Domain.parseInner 
            (fun (url : string) -> 
                async {
                    let! body = downloadHtml url
                    return body, []
                }) url
        |> Async.map fst

module TestRenderer =
    open System.Text.Json
    
    let private options = JsonSerializerOptions()
    options.Converters.Add(Serialization.JsonFSharpConverter())
    options.Encoder <- Text.Encodings.Web.JavaScriptEncoder.UnsafeRelaxedJsonEscaping
    
    let viewTo viewRef model =
        let view = JsonSerializer.Serialize (model, options)
        match !viewRef with
        | [] -> viewRef := [ view ]
        | prev :: _ when prev <> view -> viewRef := view :: !viewRef
        | _ -> ()

[<Fact>]
let ``open post`` () =
    JoyReactor.ActionModule.downloadAndParseImpl <- SyncDownloader.downloadImpl
    async {
        let viewRef : string list ref = ref []
        let dispatch : (ApplicationScreen.Msg -> unit) ref = ref (fun _ -> ())
        Program.mkProgram D.init (flip D.update) (fun model d -> dispatch := d; TestRenderer.viewTo viewRef model)
        |> Program.run

        viewRef := []
        FeedScreen.LoadNextPage |> TabsScreen.FeedMsg |> ApplicationScreen.TabsMsg |> !dispatch

        let actual = !viewRef
        let expected : string list = []
        test <@ expected = actual @>
    } |> Async.RunSynchronously

[<Fact>]
let ``open tags`` () =
    JoyReactor.ActionModule.downloadAndParseImpl <- SyncDownloader.downloadImpl
    async {
        let viewRef : string list ref = ref []
        let dispatch : (ApplicationScreen.Msg -> unit) ref = ref (fun _ -> ())
        Program.mkProgram D.init (flip D.update) (fun model d -> dispatch := d; TestRenderer.viewTo viewRef model)
        |> Program.run

        viewRef := []
        TabsScreen.SelectPage 1 |> ApplicationScreen.TabsMsg |> !dispatch

        let actual = !viewRef
        let expected =
            [ """{"history":[{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[],"userTags":[],"loaded":false}]}]}]}""" ]
        test <@ expected = actual @>

        viewRef := []
        TagsScreen.OpenTag "purpleisaprose" |> TabsScreen.TagsMsg |> ApplicationScreen.TabsMsg |> !dispatch

        let actual = !viewRef
        let expected =
            [ """{"history":[{"Case":"PostsModel","Fields":[{"source":{"Case":"TagSource","Fields":["purpleisaprose"]},"items":[{"Case":"Actual","Fields":[{"id":4435963,"userName":"vataginam","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/347929","aspect":1},"rating":5.7,"created":"2020-07-21T11:31:02","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6059738.jpeg","aspect":0.6148597422289613}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6059738.jpeg","aspect":0.6148597422289613}}],"title":"","tags":["purpleisaprose","Marnie (Pokemon)","Pokemon trainers","Pokemon Characters","Pokémon","фэндомы","Pokémon Ero","Morpeko","Pokedex"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4430415,"userName":"psionik1113","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/81101","aspect":1},"rating":6.9,"created":"2020-07-16T22:35:36","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6050828.jpeg","aspect":0.5817790530846485}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6050828.jpeg","aspect":0.5817790530846485}}],"title":"","tags":["purpleisaprose","YoRHa No.2 Type B","NieR Automata","Nier (series)","Игры","Игровая эротика"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4429443,"userName":"Дюдя","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/617551","aspect":1},"rating":15.5,"created":"2020-07-16T06:59:33","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6049269.jpeg","aspect":0.6426307448494454}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6049269.jpeg","aspect":0.6426307448494454}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6049270.jpeg","aspect":0.6426307448494454}}],"title":"","tags":["purpleisaprose","Ashe (Overwatch)","Overwatch","Blizzard","фэндомы","Overwatch Ero","под катом еще одна"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4428166,"userName":"vataginam","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/347929","aspect":1},"rating":91.7,"created":"2020-07-15T07:58:05","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6047147.jpeg","aspect":1.2955271565495208}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6047147.jpeg","aspect":1.2955271565495208}}],"title":"","tags":["The Dragon Prince","Мультфильмы","Мультэротика","purpleisaprose","art барышня","art"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4426905,"userName":"vataginam","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/347929","aspect":1},"rating":44.1,"created":"2020-07-14T07:09:26","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6044921.jpeg","aspect":0.9485380116959065}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6044921.jpeg","aspect":0.9485380116959065}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6044922.jpeg","aspect":0.7377049180327869}}],"title":"","tags":["The Dragon Prince","Мультфильмы","Мультэротика","purpleisaprose","art барышня","art"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4416179,"userName":"vataginam","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/347929","aspect":1},"rating":2.4,"created":"2020-07-04T18:38:37","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6025180.jpeg","aspect":0.5876811594202899}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/full/-6025180.jpeg","aspect":0.5876811594202899}}],"title":"","tags":["art барышня","art","Кликабельно","purpleisaprose"],"comments":[]}]},{"Case":"LoadNextDivider"}],"hasNew":false,"loading":false}]},{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""";
              """{"history":[{"Case":"PostsModel","Fields":[{"source":{"Case":"TagSource","Fields":["purpleisaprose"]},"items":[],"hasNew":false,"loading":false}]},{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""";
              """{"history":[{"Case":"PostsModel","Fields":[{"source":{"Case":"TagSource","Fields":["purpleisaprose"]},"items":[],"hasNew":true,"loading":false}]},{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""";
              """{"history":[{"Case":"PostsModel","Fields":[{"source":{"Case":"TagSource","Fields":["purpleisaprose"]},"items":[],"hasNew":false,"loading":true}]},{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""";
              """{"history":[{"Case":"PostsModel","Fields":[{"source":{"Case":"TagSource","Fields":["purpleisaprose"]},"items":[],"hasNew":false,"loading":false}]},{"Case":"TabsModel","Fields":[{"Case":"TagsModel","Fields":[{"topTags":[{"name":"CatboyKami","image":"http://img1.joyreactor.cc/pics/avatar/tag/2036401"},{"name":"Kayla Lauren","image":"http://img1.joyreactor.cc/pics/avatar/tag/1733779"},{"name":"Summer Soderstrom","image":"http://img10.joyreactor.cc/pics/avatar/tag/1982513"},{"name":"T-Kay","image":"http://img0.joyreactor.cc/pics/avatar/tag/534942"},{"name":"britkitty","image":"http://img0.joyreactor.cc/pics/avatar/tag/1895960"},{"name":"euphoriakush","image":"http://img1.joyreactor.cc/pics/avatar/tag/2019101"},{"name":"mikimakey","image":"http://img1.joyreactor.cc/pics/avatar/tag/1700177"},{"name":"purpleisaprose","image":"http://img1.joyreactor.cc/pics/avatar/tag/2030781"},{"name":"Щуга","image":"http://img0.joyreactor.cc/pics/avatar/tag/596014"},{"name":"копилка историй скорой помощи","image":"http://img0.joyreactor.cc/pics/avatar/tag/2036918"}],"userTags":[],"loaded":false}]}]}]}""" ]
        test <@ expected = actual @>
    } |> Async.RunSynchronously

[<Fact>]
let ``first open test`` () =
    JoyReactor.ActionModule.downloadAndParseImpl <- SyncDownloader.downloadImpl
    async {
        let viewRef : string list ref = ref []
        let dispatch : (ApplicationScreen.Msg -> unit) ref = ref (fun _ -> ())
        Program.mkProgram D.init (flip D.update) (fun model d -> dispatch := d; TestRenderer.viewTo viewRef model)
        |> Program.run

        let actual = !viewRef
        let expected = 
            [ """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[{"Case":"Actual","Fields":[{"id":4443859,"userName":"big_daddy","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/368715","aspect":1},"rating":12.7,"created":"2020-07-27T20:26:13","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072587.jpeg","aspect":1.3338815789473684}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072587.jpeg","aspect":1.3338815789473684}}],"title":"","tags":["алёша Ступин","artist","политота","Беларусь","страны","лукашенко","3%"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444377,"userName":"aksakal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/777455","aspect":1},"rating":7.2,"created":"2020-07-28T10:16:24","image":[],"attachments":[],"title":"","tags":["coub","собакен","милота"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444402,"userName":"I_am_just_Actor","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/596513","aspect":1},"rating":13.8,"created":"2020-07-28T10:35:24","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073588.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073589.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073590.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073591.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073592.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073593.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073594.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073595.jpeg","aspect":1.5}}],"title":"","tags":["duran","Комиксы","NSFW","что? где? когда?"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443947,"userName":"Ганфайтер","userImage":{"url":"http://img0.joyreactor.cc/pics/avatar/user/114200","aspect":1},"rating":16.6,"created":"2020-07-27T21:51:29","image":[],"attachments":[{"image":{"url":"http://img.youtube.com/vi/LrZw9p3FzNM/0.jpg","aspect":1.7777777777777777}}],"title":"","tags":["depeche mode","video"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444186,"userName":"kreuz","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/51927","aspect":1},"rating":30.6,"created":"2020-07-28T06:59:13","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}}],"title":"","tags":["гифки","самокат","Медведи"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444270,"userName":"Sentepra","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/333981","aspect":1},"rating":20.4,"created":"2020-07-28T08:43:14","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6073405.jpeg","aspect":1.0012345679012347}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6073405.jpeg","aspect":1.0012345679012347}},{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073406.jpeg","aspect":1}}],"title":"","tags":["котэ","поза","сутулость"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444341,"userName":"Naro4iTo","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/344783","aspect":1},"rating":29.5,"created":"2020-07-28T09:50:58","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073500.jpeg","aspect":0.7998027613412229}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073500.jpeg","aspect":0.7998027613412229}}],"title":"","tags":["Odeith","стрит арт","граффити"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443430,"userName":"Yaoicko","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/137887","aspect":1},"rating":17.2,"created":"2020-07-27T14:18:08","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}}],"title":"","tags":["Fire Emblem","Игры","byleth (fire emblem)","Edelgard von Hresvelg","hunter russell","гифки","Pixel Gif","Pixel Art"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444251,"userName":"Imebal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/54947","aspect":1},"rating":25,"created":"2020-07-28T08:19:31","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}}],"title":"","tags":["политика","ихтамнет","кадыровцы"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443565,"userName":"Nox7662","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/425193","aspect":1},"rating":16.4,"created":"2020-07-27T16:35:06","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072151.jpeg","aspect":0.8805646036916395}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072151.jpeg","aspect":0.8805646036916395}}],"title":"","tags":["Ghost Rider","Marvel","фэндомы","Gavin Goulden"],"comments":[]}]},{"Case":"LoadNextDivider"}],"hasNew":false,"loading":false}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[],"hasNew":false,"loading":false}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[],"hasNew":true,"loading":false}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[],"hasNew":false,"loading":true}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[],"hasNew":false,"loading":false}]}]}]}""" ]
        test <@ expected = actual @>

        viewRef := []
        FeedScreen.LoadNextPage |> TabsScreen.FeedMsg |> ApplicationScreen.TabsMsg |> !dispatch

        let actual = !viewRef
        viewRef := []
        let expected = 
            [ """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[{"Case":"Actual","Fields":[{"id":4443859,"userName":"big_daddy","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/368715","aspect":1},"rating":12.7,"created":"2020-07-27T20:26:13","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072587.jpeg","aspect":1.3338815789473684}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072587.jpeg","aspect":1.3338815789473684}}],"title":"","tags":["алёша Ступин","artist","политота","Беларусь","страны","лукашенко","3%"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444377,"userName":"aksakal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/777455","aspect":1},"rating":7.2,"created":"2020-07-28T10:16:24","image":[],"attachments":[],"title":"","tags":["coub","собакен","милота"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444402,"userName":"I_am_just_Actor","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/596513","aspect":1},"rating":13.8,"created":"2020-07-28T10:35:24","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073588.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073589.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073590.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073591.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073592.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073593.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073594.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073595.jpeg","aspect":1.5}}],"title":"","tags":["duran","Комиксы","NSFW","что? где? когда?"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443947,"userName":"Ганфайтер","userImage":{"url":"http://img0.joyreactor.cc/pics/avatar/user/114200","aspect":1},"rating":16.6,"created":"2020-07-27T21:51:29","image":[],"attachments":[{"image":{"url":"http://img.youtube.com/vi/LrZw9p3FzNM/0.jpg","aspect":1.7777777777777777}}],"title":"","tags":["depeche mode","video"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444186,"userName":"kreuz","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/51927","aspect":1},"rating":30.6,"created":"2020-07-28T06:59:13","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}}],"title":"","tags":["гифки","самокат","Медведи"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444270,"userName":"Sentepra","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/333981","aspect":1},"rating":20.4,"created":"2020-07-28T08:43:14","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6073405.jpeg","aspect":1.0012345679012347}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6073405.jpeg","aspect":1.0012345679012347}},{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073406.jpeg","aspect":1}}],"title":"","tags":["котэ","поза","сутулость"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444341,"userName":"Naro4iTo","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/344783","aspect":1},"rating":29.5,"created":"2020-07-28T09:50:58","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073500.jpeg","aspect":0.7998027613412229}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073500.jpeg","aspect":0.7998027613412229}}],"title":"","tags":["Odeith","стрит арт","граффити"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443430,"userName":"Yaoicko","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/137887","aspect":1},"rating":17.2,"created":"2020-07-27T14:18:08","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}}],"title":"","tags":["Fire Emblem","Игры","byleth (fire emblem)","Edelgard von Hresvelg","hunter russell","гифки","Pixel Gif","Pixel Art"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444251,"userName":"Imebal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/54947","aspect":1},"rating":25,"created":"2020-07-28T08:19:31","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}}],"title":"","tags":["политика","ихтамнет","кадыровцы"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443565,"userName":"Nox7662","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/425193","aspect":1},"rating":16.4,"created":"2020-07-27T16:35:06","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072151.jpeg","aspect":0.8805646036916395}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072151.jpeg","aspect":0.8805646036916395}}],"title":"","tags":["Ghost Rider","Marvel","фэндомы","Gavin Goulden"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444062,"userName":"Sentepra","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/333981","aspect":1},"rating":24.2,"created":"2020-07-28T03:48:40","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6073099.jpeg","aspect":0.6130434782608696}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/-6073099.jpeg","aspect":0.6130434782608696}},{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073100.jpeg","aspect":0.8630769230769231}}],"title":"","tags":["котэ","бабушки","Платочки","картинки"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444340,"userName":"8l8i8","userImage":{"url":"http://img0.joyreactor.cc/pics/avatar/user/393924","aspect":1},"rating":18.8,"created":"2020-07-28T09:50:22","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6073499.png","aspect":0.2209207300463089}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/-6073499.png","aspect":0.2209207300463089}}],"title":"","tags":["Раскадровка","Хью Джекман","Актеры и Актрисы","Знаменитости"],"comments":[]}]},{"Case":"LoadNextDivider"}],"hasNew":false,"loading":false}]}]}]}""";
              """{"history":[{"Case":"TabsModel","Fields":[{"Case":"FeedModel","Fields":[{"source":{"Case":"FeedSource"},"items":[{"Case":"Actual","Fields":[{"id":4443859,"userName":"big_daddy","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/368715","aspect":1},"rating":12.7,"created":"2020-07-27T20:26:13","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072587.jpeg","aspect":1.3338815789473684}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072587.jpeg","aspect":1.3338815789473684}}],"title":"","tags":["алёша Ступин","artist","политота","Беларусь","страны","лукашенко","3%"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444377,"userName":"aksakal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/777455","aspect":1},"rating":7.2,"created":"2020-07-28T10:16:24","image":[],"attachments":[],"title":"","tags":["coub","собакен","милота"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444402,"userName":"I_am_just_Actor","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/596513","aspect":1},"rating":13.8,"created":"2020-07-28T10:35:24","image":[{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}],"attachments":[{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073587.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073588.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073589.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073590.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073591.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073592.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073593.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073594.jpeg","aspect":1.5}},{"image":{"url":"http://img10.joyreactor.cc/pics/post/-6073595.jpeg","aspect":1.5}}],"title":"","tags":["duran","Комиксы","NSFW","что? где? когда?"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443947,"userName":"Ганфайтер","userImage":{"url":"http://img0.joyreactor.cc/pics/avatar/user/114200","aspect":1},"rating":16.6,"created":"2020-07-27T21:51:29","image":[],"attachments":[{"image":{"url":"http://img.youtube.com/vi/LrZw9p3FzNM/0.jpg","aspect":1.7777777777777777}}],"title":"","tags":["depeche mode","video"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444186,"userName":"kreuz","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/51927","aspect":1},"rating":30.6,"created":"2020-07-28T06:59:13","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073262.gif","aspect":1}}],"title":"","tags":["гифки","самокат","Медведи"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444270,"userName":"Sentepra","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/333981","aspect":1},"rating":20.4,"created":"2020-07-28T08:43:14","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6073405.jpeg","aspect":1.0012345679012347}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6073405.jpeg","aspect":1.0012345679012347}},{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073406.jpeg","aspect":1}}],"title":"","tags":["котэ","поза","сутулость"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444341,"userName":"Naro4iTo","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/344783","aspect":1},"rating":29.5,"created":"2020-07-28T09:50:58","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073500.jpeg","aspect":0.7998027613412229}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/full/-6073500.jpeg","aspect":0.7998027613412229}}],"title":"","tags":["Odeith","стрит арт","граффити"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443430,"userName":"Yaoicko","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/137887","aspect":1},"rating":17.2,"created":"2020-07-27T14:18:08","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/-6071819.gif","aspect":1.6666666666666667}}],"title":"","tags":["Fire Emblem","Игры","byleth (fire emblem)","Edelgard von Hresvelg","hunter russell","гифки","Pixel Gif","Pixel Art"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4444251,"userName":"Imebal","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/54947","aspect":1},"rating":25,"created":"2020-07-28T08:19:31","image":[{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}],"attachments":[{"image":{"url":"http://img0.joyreactor.cc/pics/post/-6073374.jpeg","aspect":1.3620071684587813}}],"title":"","tags":["политика","ихтамнет","кадыровцы"],"comments":[]}]},{"Case":"Actual","Fields":[{"id":4443565,"userName":"Nox7662","userImage":{"url":"http://img1.joyreactor.cc/pics/avatar/user/425193","aspect":1},"rating":16.4,"created":"2020-07-27T16:35:06","image":[{"url":"http://img1.joyreactor.cc/pics/post/-6072151.jpeg","aspect":0.8805646036916395}],"attachments":[{"image":{"url":"http://img1.joyreactor.cc/pics/post/full/-6072151.jpeg","aspect":0.8805646036916395}}],"title":"","tags":["Ghost Rider","Marvel","фэндомы","Gavin Goulden"],"comments":[]}]},{"Case":"LoadNextDivider"}],"hasNew":false,"loading":true}]}]}]}""" ]
        test <@ expected = actual @>
    } |> Async.RunSynchronously
